# 08 - Cierre de cumplimiento planProyecto

## TODOs heredados de `07 - Verificación de cumplimiento`
1. **Migrar ContenedorController a Orders.** Orders ahora expone `GET /orders/containers/pendientes` con validación de rol OPERADOR y lógica propia para cruzar solicitudes con rutas y depósitos, por lo que Logistics dejó de publicar contenedores y la consulta oficial quedó centralizada en Orders y documentada en Postman.【F:orders-service/src/main/java/com/tpibackend/orders/controller/ContenedorQueryController.java†L21-L48】【F:orders-service/src/main/java/com/tpibackend/orders/service/ContenedorQueryService.java†L18-L94】【F:TPI-2025-COMPLETE.postman_collection.json†L320-L339】
2. **Eliminar `POST /api/orders/{id}/estado` manual.** El flujo de actualización se trasladó al controlador interno `/orders/internal/logistics/{solicitudId}` protegido por el header `X-Internal-Secret`, alineado con lo documentado en la guía (ya no hay overrides manuales desde clientes externos).【F:orders-service/src/main/java/com/tpibackend/orders/controller/LogisticsIntegrationController.java†L20-L63】【F:POSTMAN_GUIDE.md†L135-L167】
3. **Encapsular el uso de `OrdersClient` en Logistics.** Se agregó la fachada `OrdersSyncGateway` para aislar las llamadas REST (con TODO explícito para migrar a eventos) y el cliente ahora firma cada request con el secreto interno configurado en `application.properties`.【F:logistics-service/src/main/java/com/tpibackend/logistics/integration/RestOrdersSyncGateway.java†L11-L37】【F:logistics-service/src/main/java/com/tpibackend/logistics/client/OrdersClient.java†L17-L63】【F:logistics-service/src/main/resources/application.properties†L22-L27】
4. **Completar entidad `Solicitud` según el DER.** Se incorporaron estado, origen/destino y coordenadas en la entidad, el request DTO, la migración `V4__restore_solicitud_estado_y_ubicaciones` y el script `initdb` para mantener consistencia en ambientes limpios.【F:orders-service/src/main/java/com/tpibackend/orders/model/Solicitud.java†L29-L82】【F:orders-service/src/main/java/com/tpibackend/orders/dto/request/SolicitudCreateRequest.java†L12-L35】【F:orders-service/src/main/resources/db/migration/V4__restore_solicitud_estado_y_ubicaciones.sql†L1-L21】【F:initdb/02-orders-schema.sql†L27-L49】
5. **Actualizar colección Postman y documentación.** La colección principal y la guía de pruebas describen ahora el flujo definitivo: estados gestionados solo desde Logistics via secret header y consultas de contenedores contra Orders.【F:TPI-2025-COMPLETE.postman_collection.json†L320-L339】【F:POSTMAN_GUIDE.md†L135-L220】

## Cambios destacados adicionales
- **Configuración de integraciones y DTOs.** Se normalizaron las rutas del `LogisticsClient` de Orders para incluir la consulta de depósitos y la ruta `/routes/solicitudes/{solicitudId}` exigida por los planes.【F:orders-service/src/main/resources/application.properties†L6-L16】
- **Seguridad con prioridad alta.** El `SecurityExceptionHandler` ahora tiene la mayor precedencia y maneja explícitamente `AuthorizationDeniedException`, evitando 500 en los tests de controladores cuando se esperan 401/403.【F:orders-service/src/main/java/com/tpibackend/orders/exception/SecurityExceptionHandler.java†L3-L31】
- **Contexto de pruebas estable.** Se agregó un perfil `test` con H2 y Flyway deshabilitado más la activación correspondiente del `@SpringBootTest` para que la suite de Orders levante sin Postgres externo.【F:orders-service/src/test/resources/application-test.properties†L1-L8】【F:orders-service/src/test/java/com/tpibackend/orders/OrdersServiceApplicationTests.java†L7-L14】

## Pruebas ejecutadas
- ✅ `mvn -f orders-service/pom.xml test` (suite completa en verde).【99aaa1†L1-L22】
- ⚠️ `mvn -f logistics-service/pom.xml test` (falla conocida: el artefacto privado `com.tpibackend.distance:distance-client:1.0.0` no está disponible en Maven Central).【570b54†L1-L17】

## Deuda técnica documentada
- **Mensajería/eventos pendientes:** aunque el uso de `OrdersClient` quedó encapsulado, la implementación sigue siendo REST y se dejó registrado el TODO de migrar a un broker cuando exista infraestructura común.【F:logistics-service/src/main/java/com/tpibackend/logistics/integration/RestOrdersSyncGateway.java†L11-L36】
- **Dependencia externa faltante:** los tests de Logistics seguirán fallando en entornos sin el JAR propietario `distance-client`, ya que Maven no puede resolverlo automáticamente.【570b54†L1-L17】

## Estado final respecto a `/planProyecto`
- Orders es el único dueño de contenedores y seguimiento, incluidos los endpoints internos y públicos descritos en los planes, mientras que Logistics solo dispara eventos operativos mediante el secret compartido.【F:orders-service/src/main/java/com/tpibackend/orders/controller/ContenedorQueryController.java†L21-L48】【F:orders-service/src/main/java/com/tpibackend/orders/controller/LogisticsIntegrationController.java†L20-L63】
- Los documentos funcionales (colección y guía) reflejan exactamente estos flujos, por lo que el proyecto queda alineado al plan salvo la futura adopción de mensajería física para reemplazar el gateway REST temporal.【F:TPI-2025-COMPLETE.postman_collection.json†L320-L339】【F:POSTMAN_GUIDE.md†L135-L220】
